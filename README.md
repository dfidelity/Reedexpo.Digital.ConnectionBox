# ConnectionBoxThis service records connections between exhibitors and visitors. It allows for lead retrieval.It contains:- .Net Core 2 Web.Api project configured to Atlas standards.- Swagger endpoint on [root URL](https://connectionbox-dev.css.rxweb-dev.com/swagger/).- Logging to [Splunk](https://reedexpo.splunkcloud.com/en-GB/app/search/connectionbox) using the reedexpo logging package.- [Health-check](https://connectionbox-dev.css.rxweb-dev.com/health) end point and framework.- Basic metrics reporting to Splunk.- Unit tests using XUnit.- [API integration tests](https://atlassian.rxweb-prd.com/builds/build/result/artifactUrlRedirect.action?planKey=CSS-CONI&artifactName=API%20Test%20results) using apickli/cucumber.js.- [API load tests](https://atlassian.rxweb-prd.com/builds/build/result/artifactUrlRedirect.action?planKey=CSS-CONL-JOB1&artifactName=results)  using Gatling.- Build configuration with corresponding [Bamboo build plan](https://atlassian.rxweb-prd.com/builds/browse/CSS-CON).- Deployment configuration with corresponding [Bamboo deployment project](https://atlassian.rxweb-prd.com/builds/deploy/viewDeploymentProjectEnvironments.action?id=130646019).- Quality gates with [SonarQube](https://sq.rxweb-dev.com/dashboard?id=ReedexpoDigitalConnection).### DevelopmentInstall .NET SDK from https://www.microsoft.com/net/download (2.2.202)Install Docker for Mac if you are using Mac machine##### Setup NuGet- `cp NuGet.config.template ~/.config/NuGet/NuGet.Config`- Replace PROGET_URL with the "https://proget.rxweb-tools.com/nuget/Default".- Follow these [instructions](https://app.mural.co/invitation/mural/thoughtworksclientprojects1205/1613992183151?sender=chanakg1030&key=887cbfc2-226e-4aa6-afc9-b6a0fcb71ca1) to configure VPN.- Open the solution in your IDE and "Restore NuGet Packages" to download all dependencies.- Note: it looks like the password in `NuGet.config` needs to be encrypted. Opening Visual Studio and hitting `Preferences`,  `Nuget`, `Sources` and updating the password of the last source in there with your PROGET_PASSWORD should solve the problem.##### Setup Environment- Create `.env` file in `src` directory and copy environment variables from `Connectionbox Environment variables` secure note in Emperia 1password vault and paste it in `.env` file##### Setup Powershell```shbrew cask install powershell```##### Setup AWS credentialsA few API tests integrate with the AWS SES Mailbox Simulator and require AWS credentials, ie. you must run:```shaws configure```and configure your local machine with your Reed Exhibitions' AWS account with region as 'eu-west-1'.##### Run integration tests locally with goaws and proxy server for caching axios calls from API```sh# Make sure a local database is running# Ensure reedexpodigitalconnectionbox_goaws is running in the docker console# Ensure reedexpodigitalconnectionbox_proxy-server is running in the docker consoledocker-compose up# Start app locallydotnet run --project src/Reedexpo.Digital.ConnectionBoxcd test/Reedexpo.Digital.ConnectionBox.Integration.Testnpm installnpm run api-test:localnpm run report```### Starting the proxy serverProxy is currently integrated with docker-compose. So docker-compose up should already start the proxy server.The proxy code is available at /test/Reedexpo.Digital.ConnectionBox.Integration.Test/proxy_server##### Create ConnectionBox.Proxy.Api launch settins profile - Setup is needed only onceFrom the ```Edit Configurations...``` -> Add a new ```.Net Launch Settings profile``` and add the launchSettings.json and select the Launch Profile as ```ConnectionBox.Proxy.Api``` and Apply.By default existing workflow remains as it is.Run the ```ConnectionBox.Proxy.Api``` launch settings profile to run in proxy mode .##### Setup load test locally1. Install sbt tool2. Make sure you have java1.8 and set it to $JAVA_HOME3. To test in the actual aws, temporarily comment out the localstack, goawsin the docker-compose and restart it4. Run the `aws-afs-mfa-login` code to get the aws `access_key, secretand token`5. Add all the above three along with `adminToken, companyEmail, accessCode` in `./runDefaultLocal.sh`6. Make sure you have created the `eventEditionId` present in the ExhibitorEventScenarioin your local swagger along with the correct POST request body7. Run your service in local and after that run the `sh ./runDefaultLocal.sh`##### Run load tests locally```shcd test/Reedexpo.Digital.ConnectionBox.Load.Test./runDefaultLocal.sh```#### Database##### Update a local database with latest```sh# Make sure a local database is runningdocker-compose up# Update the schemacd src/Reedexpo.Digital.ConnectionBoxdotnet ef database update```##### Create a database schema migrationMake the required changes to the models and edit model relationships in `ConnectionsContext` if necessary. Then run:```sh# Make sure a local database is runningdocker-compose up# Create the migrationdotnet ef migrations add <MigrationName>```This will create a new migration file in folder `Migrations` and migrate the database at the same time.### Nova##### PostmanUse the collection in directory `postman` to explore Nova APIs. Read the Postman description to get started.### Atlas##### PostmanUse the collection in directory `postman` to explore our own Atlas APIs. We have Swagger but this can be usefulbecause these are the Apigee API Gateway endpoints.##### Create authentication tokens for temporary users(This is probably not something you need to do but it allows creating dynamic clients with given scopes and claims).It requires AWS credentials setup on the machine.```shCLIENT_ID=$(credstash --table css-secrets get policebox-dev-DIGITAL_CLIENT_MANAGEMENT_API-client_id)CLIENT_SECRET=$(credstash --table css-secrets get policebox-dev-DIGITAL_CLIENT_MANAGEMENT_API-client_secret)ACCESS_TOKEN=$(curl -X POST \  https://policebox-dev.css.rxweb-dev.com/secure/connect/token/ \  -H 'cache-control: no-cache' \  -H 'content-type: application/x-www-form-urlencoded' \  -d "client_id=${CLIENT_ID}&client_secret=${CLIENT_SECRET}&grant_type=client_credentials&scope=urn%3Arx%3Adigital%3Aopenid%3Aclient%3Awrite" \  | jq '.access_token')# If you get {"error":"invalid_client"}, make sure client_id and client_secret are url encoded.curl -X POST \  https://policebox-dev.css.rxweb-dev.com/connect/clients \  -H "Authorization: Bearer $ACCESS_TOKEN" \  -H 'Content-Type: application/json' \  -d '{ "client_name": "Organisation-specific API client", "access_token_lifetime": 30, "scope": "urn:rx:digital:programme:write", "claims": [{ "Type": "rxOrg", "Value": "org-id1" }] }' \  | jq```### Use S3 buckets for self-hosted imagesWe host our images that are embedded in the emails in s3 buckets. The code can be found under: `assets/upload_images_to_s3`Each environment has its own S3 bucket that is configured in environment.json files in`Deploy/config/{env}/environment.json` as `assetsS3BucketUrl`.Steps to add new assets:- include in assets/images- run `node assets/upload_images_to_s3.js`- commit to kick off assets pipeline, note build number- manually bump version in all `config/{ENV}/environment.json` files for attribute `assetsS3BucketUrl`- also bump for `appsettings.json`### Show support scriptsOnly to be used until the show team portal has been completed to support show teams. This is not a production code.Show support scripts are located in `tools/` folder.In order to run most of these scripts you need to have `node.js` installed:```brew install node```If everything installed successfully then you can type in the following command in the terminal to check the Node and NPM version.```node -vnpm -v```and you can run it with node command, for example:```npm installnode export.js --type visitors --showId 67889e4s1b0e4```You will also need to know:-authtoken-xclientid-any params, for example -showidThere are five folders, as follows:- exportCsv - used during the show in order to export show data for the use of the show team. You can export connections, exhibitors and visitors per show- hackyDashboard - credits to the previous tech lead, Marc L., who put it together so some tasks (like sending EOD emails can be done without using postman) - hacky as the name suggest(!)- importLiveBuzzVisitors - script to import visitors data from an external vendor (LiveBuzz specific in this case)- sendAccessRequestsToExhibitors - activating exhibitors by calling access-request endpoint- updater - used after a show in order to meet the security requirements to limit access to Emperia app. It updates the access codes and report codes for exhibitors, so that they are unable to login nor download the show reports after the show has been completed and the agreed time past (a week)### Creating jwt secret for jwt access tokenYou can create the jwt secret running this node script in your terminal:```node -e "console.log(require('crypto').randomBytes(256).toString('hex'));"```### Learning- [Lean X in Y minutes for C#](https://learnxinyminutes.com/docs/csharp/)